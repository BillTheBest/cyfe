--Second part of script to sum customer contract value

--Create Pagination Table

stage_table = {"quote", "custom1","custom2","custom3","closure"}
pagination_table = {1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20}

local pipeline_lead_count = 0
local date = os.date("%d") - 1
local yesterday = string.format(os.date("%Y-%m-").."%02d",date)
local yesterday_cyfe = string.format(os.date("%Y%m").."%02d",date)

local pipeline_deal_scope = storage.pipeline_deal_scope
local pipeline_deal_weighted_scope = storage.pipeline_deal_weighted_scope

--Make calls to Base

for key,value in  pairs(stage_table) do
	local stage_key = value
	for key,value in  pairs(pagination_table) do
		local page_key = value
		local response = http.request {
		url = 'https://sales.futuresimple.com/api/v1/deals.json?',
		params = {
			page = page_key,
			stage = stage_key,
			indexing = "true"		
			},
		headers = {
			['X-Pipejump-Auth']= 'YOUR KEY HERE',
			}
		}
		local JSON = json.parse(response.content)
		if response.content == "[]" then break end
		for key,value in pairs(JSON) do
				pipeline_deal_scope = pipeline_deal_scope + JSON[key].deal.scope
				if JSON[key].deal.estimated_win_likelihood then
				pipeline_deal_weighted_scope = pipeline_deal_weighted_scope + JSON[key].deal.scope*(JSON[key].deal.estimated_win_likelihood*.01)
				end		
		end
	end	
end

--Create Data to Send to Cyfe

local pipeline_deal_scope_table = {["data"] = {[1] = { ["Date"] = yesterday_cyfe, ["Unweighted Pipeline Value($)"] = pipeline_deal_scope,["Weighted Pipeline Value($)"] = pipeline_deal_weighted_scope } }, ["onduplicate"] = {["Unweighted Pipeline Value($)"] = "replace",["Weighted Pipeline Value($)"] = "replace"}, ["cumulative"] = {["Unweighted Pipeline Value($)"] = "1", ["Weighted Pipeline Value($)"] = "1"}, ["yaxis"] = {["Unweighted Pipeline Value($)"] = "0", ["Weighted Pipeline Value($)"] = "0"}}
local pipeline_deal_scope_json = json.stringify(pipeline_deal_scope_table)

-- Push Data to Cyfe

local push_pipeline_deal_scope = http.request {
	method='post',
	url = 'YOUR CYFE URL HERE',
	data = pipeline_deal_scope_json
}

return "200"
